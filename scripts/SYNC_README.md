# 500区块同步脚本使用说明

本文档介绍如何使用一键启动脚本来同步最近500个区块的USDT转账数据。

## 脚本文件

- `sync-500-blocks.bat` - Windows批处理脚本
- `sync-500-blocks.sh` - Linux/macOS Shell脚本

## 功能特性

- ✅ 自动同步最近500个区块的数据
- ✅ 实时性能监控，检测系统卡死风险
- ✅ 智能错误处理和重试机制
- ✅ 详细的同步进度和统计信息
- ✅ 环境检查和依赖验证
- ✅ 优雅的信号处理和安全退出

## 使用方法

### Windows系统

1. 双击运行 `sync-500-blocks.bat`
2. 或在命令行中执行：
   ```cmd
   cd /d "项目根目录\scripts"
   sync-500-blocks.bat
   ```

### Linux/macOS系统

1. 在终端中执行：
   ```bash
   cd 项目根目录/scripts
   chmod +x sync-500-blocks.sh  # 首次运行需要添加执行权限
   ./sync-500-blocks.sh
   ```

## 环境要求

### 必需环境
- Go 1.19+ 已安装并配置在PATH中
- PostgreSQL数据库已启动并可连接
- 项目根目录存在 `.env` 配置文件

### 配置检查
脚本会自动检查以下环境：
- ✅ Go环境是否可用
- ✅ 项目依赖是否完整
- ✅ 配置文件是否存在
- ✅ 数据库连接是否正常

## 同步过程

### 1. 初始化阶段
- 加载配置文件
- 初始化数据库连接
- 创建服务依赖（TransferService, MarketService）
- 启动性能监控器

### 2. 区块范围计算
- 获取链上最新区块号
- 计算同步范围：`[最新区块号-499, 最新区块号]`
- 显示同步目标和预计时间

### 3. 数据同步
- 支持顺序同步和并发同步两种模式
- 实时监控内存使用和Goroutine数量
- 自动重试失败的区块
- 记录详细的同步日志

### 4. 完成统计
- 显示总耗时和平均每区块处理时间
- 展示最终的系统资源使用情况
- 检测潜在的内存泄漏或性能问题

## 监控功能

### 性能监控
- **内存监控**: 超过100MB时发出警告
- **Goroutine监控**: 超过50个时发出警告
- **卡死检测**: 连续5次无变化时自动退出
- **实时统计**: 每3秒输出一次系统状态

### 告警机制
- 🟡 警告级别：性能指标接近阈值
- 🔴 错误级别：系统异常需要干预
- 🚨 严重级别：自动退出保护系统

## 输出示例

```
=== 多节点系统监控同步开始 ===
目标: 同步500个区块
监控: 实时性能监控，检测卡死风险
========================================

同步范围: 65234567 - 65235066 (共500个区块)
开始时间: 2024-01-15 14:30:25
========================================

[监控] 时间: 14:30:28 | Goroutines: 12 | 内存: 45.67 MB | GC次数: 3
[监控] 时间: 14:30:31 | Goroutines: 15 | 内存: 52.34 MB | GC次数: 4

✅ 同步完成！

========================================
=== 同步完成统计 ===
总耗时: 2m34s
平均每区块: 308ms
最终Goroutines: 8
最终内存使用: 38.92 MB
总GC次数: 12
========================================
```

## 故障排除

### 常见问题

1. **Go环境未找到**
   - 确保已安装Go 1.19+
   - 检查PATH环境变量是否包含Go的bin目录

2. **配置文件缺失**
   - 确保项目根目录存在 `.env` 文件
   - 参考 `.env.example` 配置必要的环境变量

3. **数据库连接失败**
   - 检查PostgreSQL服务是否启动
   - 验证 `.env` 中的数据库连接配置

4. **同步失败或卡死**
   - 检查网络连接是否稳定
   - 查看日志文件 `logs/app.log` 获取详细错误信息
   - 性能监控器会自动检测并退出卡死进程

### 日志文件
- 主日志：`logs/app.log`
- 错误日志：控制台输出
- 性能日志：实时监控输出

## 高级配置

### 环境变量
可以通过 `.env` 文件调整以下参数：

```env
# 节点健康检查间隔
NODE_HEALTH_CHECK_INTERVAL=60s

# 同步配置
SYNC_INTERVAL=30s
START_BLOCK=0

# 并发配置
CONCURRENT_WORKERS=4
CHUNK_SIZE=25

# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=usdt_indexer
DB_USER=postgres
DB_PASSWORD=your_password
```

### 性能调优
- **内存阈值**: 修改 `memoryThreshold` (默认100MB)
- **Goroutine阈值**: 修改 `goroutineThreshold` (默认50个)
- **监控间隔**: 修改监控循环的ticker间隔 (默认3秒)

## 注意事项

⚠️ **重要提醒**：
- 同步过程中请勿强制终止程序，使用 Ctrl+C 优雅退出
- 确保数据库有足够的存储空间
- 网络不稳定时可能需要多次重试
- 大量数据同步时建议在低峰期执行

## 技术支持

如遇到问题，请：
1. 查看控制台输出和日志文件
2. 检查系统资源使用情况
3. 验证网络连接和数据库状态
4. 提供完整的错误信息和环境配置